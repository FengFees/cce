# 为组件添加灰度版本<a name="cce_01_0039"></a>

当部署新的灰度版本到已有组件上时，需要添加灰度版本。一个组件中仅支持发布一个灰度版本，并支持为版本添加灰度策略。

## 基本概念<a name="section695502711820"></a>

-   灰度版本：一个组件仅支持发布一个灰度版本，可以对灰度版本配置相应的灰度策略。

-   灰度策略：当您需要在生产环境发布一个新的待上线版本时，您可以选择添加一个灰度版本，并配置相应的灰度策略，将原有的生产环境的默认版本的流量引流一部分至此。经过评估稳定后，可以将此灰度版本接管所有流量，下线原来的版本，从而接管原有的生产环境的版本上的流量。

## 添加灰度版本<a name="section207383441272"></a>

1.  在CCE左侧导航栏中选择“应用管理  \> 灰度发布”，在金丝雀发布下单击“创建”。
2.  配置灰度版本基本信息。
    -   灰度发布组件：单击“选择组件”，选择添加灰度版本的组件。
    -   发布任务名称：系统自动生成，可根据实际需求进行修改。
    -   版本号：新增服务中灰度版本号。

    -   版本描述：灰度版本描述信息。

3.  根据界面提示的流程图，熟悉灰度发布版本流程，单击“创建”。
4.  部署灰度版本。
    -   实例数量：灰度版本的实例数量。灰度版本可以有一个或多个实例，用户可根据实际需求进行修改。每个灰度版本的实例都由相同的容器部署而成。
    -   镜像名称：默认为该组件的镜像。
    -   镜像版本：请选择需要添加灰度的镜像版本。
    -   配置高级设置。默认继承已有灰度版本的配置，若新建灰度版本有特殊要求，可进行修改。
        -   资源分配：单击![](figures/icon-edit.png)可更改申请和限制的配额。申请和限制的含义如下。详细请参见[设置容器规格](设置容器规格.md)。
            -   申请：表示应用运行所需最少资源。
            -   限制：若担心应用超载，导致系统故障。建议设置应用配额的最高限制。确保应用资源不会超额。

        -   环境变量：

            在“环境变量“页签，单击“添加环境变量“。当前支持三种类型。

            -   手动添加：输入变量名称、变量/变量引用。
            -   密钥导入：输入变量名称，选择导入的密钥名称和数据。您需要提前创建密钥，详情请参见[创建密钥](创建密钥.md)。
            -   配置项导入：输入变量名称，选择导入的配置项名称和数据。您需要提前创建配置项，详情请参见[创建配置项](创建配置项.md)。

        -   健康检查：用于判断容器和用户业务是否正常运行。设置了存活与业务两种探针。详细配置方法同[容器健康检查](容器健康检查.md)。
            -   应用存活探针：监测到容器实例不健康时，重启应用。
            -   应用业务探针：监测到容器实例不健康时，将工作负载设置为未就绪状态，业务流量不会导入到该容器中。

        -   数据存储：给容器挂载数据存储，适用于需持久化存储、高磁盘IO等场景。详细配置请参见[存储管理](存储管理.md)。
        -   容器日志：设置容器日志采集策略、配置日志目录。用于收集容器日志便于统一管理和分析。详细配置请参见[日志管理](日志管理.md)。
        -   生命周期：用于管理容器各阶段需要执行的命令。
            -   启动命令：设置容器启动时执行的命令。详情请参见[设置容器启动命令](设置容器启动命令.md)。
            -   启动后处理：设置容器成功运行后执行的命令。详细配置方法请参见[设置容器生命周期](设置容器生命周期.md)。
            -   停止前处理：设置容器结束前执行的命令，通常用于删除日志/临时文件等。详细配置方法请参见[设置容器生命周期](设置容器生命周期.md)。



5.  单击“部署灰度版本“，灰度版本开始创建。

    请确保灰度版本的实例状态为正常时，再开始下一步进行灰度策略的配置。

6.  单击“配置灰度策略”，进行灰度策略配置（可选）。

    策略类型：分为“基于请求内容发布”和“基于流量比例发布”两种类型，通过页签选择确定。

    -   基于请求内容发布：对当前版本配置相应的请求内容规则，服务流量在满足此规则的情况下，会走此版本。例如http请求，请求头cookie必须满足“访问条件“走版本A。
    -   基于流量比例发布：对当前版本配置相应的流量权重，服务流量将会按照权重比率以对应的概率分发当前版本。例如10%的流量走版本A，90%的流量走版本B。

    >![](public_sys-resources/icon-notice.gif) **注意：**   
    >-   若当前组件已经有灰度版本并配置了灰度策略，则策略类型不可选（一个组件下的所有灰度版本只能配置一种策略类型），默认为已经配置的策略类型。  
    >-   基于请求内容发布策略只对直接访问的入口服务有效。如果希望对所有服务有效，需要业务代码对HEAD信息传播，方法可参考[如何使用Istio调用链埋点](流量监控.md#section437112311448)。  

    **表 1**  基于请求内容发布

    <a name="table1184516442710"></a>
    <table><thead align="left"><tr id="row124304515719"><th class="cellrowborder" valign="top" width="25%" id="mcps1.2.3.1.1"><p id="p824319451715"><a name="p824319451715"></a><a name="p824319451715"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="75%" id="mcps1.2.3.1.2"><p id="p6243145279"><a name="p6243145279"></a><a name="p6243145279"></a>参数说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row18243184517718"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p724316451276"><a name="p724316451276"></a><a name="p724316451276"></a>Cookie内容</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><a name="ul16981953114618"></a><a name="ul16981953114618"></a><ul id="ul16981953114618"><li>完全匹配：当且仅当表达式完全符合此情况时，流量才会走到这个版本</li><li>正则匹配：此处需要您使用正则表达式来匹配相应的规则</li></ul>
    </td>
    </tr>
    <tr id="row57594698163823"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p34658933163823"><a name="p34658933163823"></a><a name="p34658933163823"></a>允许访问的操作系统</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="p55910193163823"><a name="p55910193163823"></a><a name="p55910193163823"></a>请选择允许访问的操作系统。</p>
    </td>
    </tr>
    <tr id="row20053750163835"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p13741066163835"><a name="p13741066163835"></a><a name="p13741066163835"></a>允许访问的浏览器</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="p39284525163835"><a name="p39284525163835"></a><a name="p39284525163835"></a>请选择允许访问的浏览器。</p>
    </td>
    </tr>
    <tr id="row4982614816408"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p938620516408"><a name="p938620516408"></a><a name="p938620516408"></a>配置文件</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="p2208511016408"><a name="p2208511016408"></a><a name="p2208511016408"></a>展示策略YAML文件。</p>
    </td>
    </tr>
    <tr id="row102442451479"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p5244645979"><a name="p5244645979"></a><a name="p5244645979"></a>编辑规则描述</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="p10244114511716"><a name="p10244114511716"></a><a name="p10244114511716"></a>当前服务的流量转发的规则描述信息。</p>
    </td>
    </tr>
    </tbody>
    </table>

    **表 2**  基于流量比例发布

    <a name="table2633749163621"></a>
    <table><thead align="left"><tr id="row60092824163621"><th class="cellrowborder" valign="top" width="25%" id="mcps1.2.3.1.1"><p id="p52690018163621"><a name="p52690018163621"></a><a name="p52690018163621"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="75%" id="mcps1.2.3.1.2"><p id="p40033081163621"><a name="p40033081163621"></a><a name="p40033081163621"></a>参数说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row28609634163621"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p52648224163746"><a name="p52648224163746"></a><a name="p52648224163746"></a>流量配比</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="p36647776163746"><a name="p36647776163746"></a><a name="p36647776163746"></a>当选择<span class="uicontrol" id="uicontrol61394534163746"><a name="uicontrol61394534163746"></a><a name="uicontrol61394534163746"></a>“基于流量比例发布”</span>时，您需要设置流量配比，根据输入的流量配比来确定流量分发的比重。</p>
    <p id="p15679897163746"><a name="p15679897163746"></a><a name="p15679897163746"></a><strong id="b6901346163746"><a name="b6901346163746"></a><a name="b6901346163746"></a>输入流量配比：</strong></p>
    <p id="p62112114163746"><a name="p62112114163746"></a><a name="p62112114163746"></a>范围限制为[0,默认版本权重w]，例如，当您配置为10，则10%的服务流量会走向此版本，(w-10)%的流量会走向默认版本，即从默认版本分走一部分流量。</p>
    </td>
    </tr>
    <tr id="row38853013163621"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="p48356782163746"><a name="p48356782163746"></a><a name="p48356782163746"></a>编辑规则描述</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="p24585295163746"><a name="p24585295163746"></a><a name="p24585295163746"></a>当前服务的流量转发的规则描述信息。</p>
    </td>
    </tr>
    </tbody>
    </table>

7.  单击“策略下发“。

    灰度策略的生效需要几秒时间，您可以在监测灰度运行状态页面，观察灰度版本的运行状态。


