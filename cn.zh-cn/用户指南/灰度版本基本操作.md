# 灰度版本基本操作<a name="cce_01_0043"></a>

您可以对现有的服务进行多个版本的管理，针对不同版本配置不同的策略，从而达到流量管理的目的。

## 前提条件<a name="section1924182985518"></a>

管理灰度版本前，请确保已为服务添加灰度版本，详细请参见[为组件添加灰度版本](为组件添加灰度版本.md)。

## 使用说明<a name="section1848961318567"></a>

对灰度版本的相关基本操作，其原理是修改Istio的destinationrule和virtualservice两个资源的配置信息，修改完成后，需要等待10秒左右，新的策略规则才会生效。

## 添加版本的灰度策略<a name="section26760523562"></a>

若您在添加灰度版本时，未配置灰度策略，可以基于以下步骤创建策略。

1.  在CCE左侧导航栏中选择“应用治理“，打开[应用服务网格控制台](https://console.huaweicloud.com/istio/)，单击左侧导航栏中的“灰度发布“。
2.  单击已创建灰度任务的名称，进入查看灰度版本状态页面。
3.  单击“配置灰度策略”。在灰度策略配置中，单击策略类型下的“基于请求内容策略“或“基于流量比例策略“。

    **表 1**  基于请求内容发布

    <a name="table847413118431"></a>
    <table><thead align="left"><tr id="cce_01_0039_row124304515719"><th class="cellrowborder" valign="top" width="25%" id="mcps1.2.3.1.1"><p id="cce_01_0039_p824319451715"><a name="cce_01_0039_p824319451715"></a><a name="cce_01_0039_p824319451715"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="75%" id="mcps1.2.3.1.2"><p id="cce_01_0039_p6243145279"><a name="cce_01_0039_p6243145279"></a><a name="cce_01_0039_p6243145279"></a>参数说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="cce_01_0039_row18243184517718"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p724316451276"><a name="cce_01_0039_p724316451276"></a><a name="cce_01_0039_p724316451276"></a>Cookie内容</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><a name="cce_01_0039_ul16981953114618"></a><a name="cce_01_0039_ul16981953114618"></a><ul id="cce_01_0039_ul16981953114618"><li>完全匹配：当且仅当表达式完全符合此情况时，流量才会走到这个版本</li><li>正则匹配：此处需要您使用正则表达式来匹配相应的规则</li></ul>
    </td>
    </tr>
    <tr id="cce_01_0039_row57594698163823"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p34658933163823"><a name="cce_01_0039_p34658933163823"></a><a name="cce_01_0039_p34658933163823"></a>允许访问的操作系统</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="cce_01_0039_p55910193163823"><a name="cce_01_0039_p55910193163823"></a><a name="cce_01_0039_p55910193163823"></a>请选择允许访问的操作系统。</p>
    </td>
    </tr>
    <tr id="cce_01_0039_row20053750163835"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p13741066163835"><a name="cce_01_0039_p13741066163835"></a><a name="cce_01_0039_p13741066163835"></a>允许访问的浏览器</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="cce_01_0039_p39284525163835"><a name="cce_01_0039_p39284525163835"></a><a name="cce_01_0039_p39284525163835"></a>请选择允许访问的浏览器。</p>
    </td>
    </tr>
    <tr id="cce_01_0039_row4982614816408"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p938620516408"><a name="cce_01_0039_p938620516408"></a><a name="cce_01_0039_p938620516408"></a>配置文件</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="cce_01_0039_p2208511016408"><a name="cce_01_0039_p2208511016408"></a><a name="cce_01_0039_p2208511016408"></a>展示策略YAML文件。</p>
    </td>
    </tr>
    <tr id="cce_01_0039_row102442451479"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p5244645979"><a name="cce_01_0039_p5244645979"></a><a name="cce_01_0039_p5244645979"></a>编辑规则描述</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="cce_01_0039_p10244114511716"><a name="cce_01_0039_p10244114511716"></a><a name="cce_01_0039_p10244114511716"></a>当前服务的流量转发的规则描述信息。</p>
    </td>
    </tr>
    </tbody>
    </table>

    **表 2**  基于流量比例发布

    <a name="table11406019164546"></a>
    <table><thead align="left"><tr id="cce_01_0039_row60092824163621"><th class="cellrowborder" valign="top" width="25%" id="mcps1.2.3.1.1"><p id="cce_01_0039_p52690018163621"><a name="cce_01_0039_p52690018163621"></a><a name="cce_01_0039_p52690018163621"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="75%" id="mcps1.2.3.1.2"><p id="cce_01_0039_p40033081163621"><a name="cce_01_0039_p40033081163621"></a><a name="cce_01_0039_p40033081163621"></a>参数说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="cce_01_0039_row28609634163621"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p52648224163746"><a name="cce_01_0039_p52648224163746"></a><a name="cce_01_0039_p52648224163746"></a>流量配比</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="cce_01_0039_p36647776163746"><a name="cce_01_0039_p36647776163746"></a><a name="cce_01_0039_p36647776163746"></a>当选择<span class="uicontrol" id="cce_01_0039_uicontrol61394534163746"><a name="cce_01_0039_uicontrol61394534163746"></a><a name="cce_01_0039_uicontrol61394534163746"></a>“基于流量比例发布”</span>时，您需要设置流量配比，根据输入的流量配比来确定流量分发的比重。</p>
    <p id="cce_01_0039_p15679897163746"><a name="cce_01_0039_p15679897163746"></a><a name="cce_01_0039_p15679897163746"></a><strong id="cce_01_0039_b6901346163746"><a name="cce_01_0039_b6901346163746"></a><a name="cce_01_0039_b6901346163746"></a>输入流量配比：</strong></p>
    <p id="cce_01_0039_p62112114163746"><a name="cce_01_0039_p62112114163746"></a><a name="cce_01_0039_p62112114163746"></a>范围限制为[0,默认版本权重w]，例如，当您配置为10，则10%的服务流量会走向此版本，(w-10)%的流量会走向默认版本，即从默认版本分走一部分流量。</p>
    </td>
    </tr>
    <tr id="cce_01_0039_row38853013163621"><td class="cellrowborder" valign="top" width="25%" headers="mcps1.2.3.1.1 "><p id="cce_01_0039_p48356782163746"><a name="cce_01_0039_p48356782163746"></a><a name="cce_01_0039_p48356782163746"></a>编辑规则描述</p>
    </td>
    <td class="cellrowborder" valign="top" width="75%" headers="mcps1.2.3.1.2 "><p id="cce_01_0039_p24585295163746"><a name="cce_01_0039_p24585295163746"></a><a name="cce_01_0039_p24585295163746"></a>当前服务的流量转发的规则描述信息。</p>
    </td>
    </tr>
    </tbody>
    </table>

4.  单击“策略下发“，灰度策略会自动生效。

## 修改版本的灰度策略<a name="section57825471454"></a>

-   修改基于流量比例的策略：

    基于流量比例的策略（又称为AB TEST策略）所有版本的权重之和为100，即：假设默认版本的权重为x，当前待修改版本的权重为y，其他版本的权重为z，则x+y+z=100。

    当您此时将待修改版本的权重从y改成y1，则默认版本的权重会自动改为x-y1+y，即待修改版本的权重会影响到默认版本的权重。

-   修改基于请求内容的策略：

    基于请求内容的策略（又称为金丝雀策略）会遍历除默认版本外的全部金丝雀规则，若满足某个版本的规则，则流量走向此版本，若全部不满足，则流量会走到默认版本，即：假设当您此时将待修改版本的匹配策略为x。

    当您此时将待修改版本的匹配策略从x改成x1，则原本满足x规则的流量将会走到默认版本，而满足新规则x1的流量将会走到当前的待修改版本。


## 切换灰度策略类型<a name="section9745163813214"></a>

您可以在“基于请求内容的策略“和“基于流量比例的策略“之间切换。策略完成切换后，原本配置的规则将全部失效，所有的流量，会根据配置的新策略重新分配。

>![](public_sys-resources/icon-notice.gif) **注意：**   
>只有**发布中**的任务才支持灰度策略变更，版本发布完成后（即新版本完全接管旧版本流量，且旧版本已下线），将不支持重新配置灰度策略。  

1.  在CCE左侧导航栏中选择“应用治理“，打开[应用服务网格控制台](https://console.huaweicloud.com/istio/)，单击左侧导航栏中的“灰度发布“。
2.  单击已创建灰度版本的名称。
3.  在监测灰度运行状态页面，单击“查看/配置灰度策略”。
4.  参照[6](为组件添加灰度版本.md#li5242204519710)重新配置灰度策略。
5.  配置完成后，单击“策略下方”。此操作完成后，原本配置的规则将全部失效，所有的流量，都会根据配置的新策略重新分配，请谨慎操作。

## 切为默认流量版本<a name="section124701017142211"></a>

执行某个版本（如V2版本）后的“接管所有流量“，V2版本将获取到原默认版本的全部流量。原默认版本流量将变为0。

## 下线灰度版本<a name="section4846173143614"></a>

若下线了某个灰度版本，则该版本的流量会被新版本完全接管。

1.  在CCE左侧导航栏中选择“应用治理“，打开[应用服务网格控制台](https://console.huaweicloud.com/istio/)，单击左侧导航栏中的“灰度发布“。
2.  单击已创建灰度任务的名称。
3.  单击待下线版本后的“版本下线”，下线该版本。

## 设置服务访问方式<a name="section7817603536"></a>

若您在创建组件时，未配置外部服务访问方式，可以基于以下步骤创建策略。

1.  在CCE左侧导航栏中选择“应用治理“，打开[应用服务网格控制台](https://console.huaweicloud.com/istio/)，单击左侧导航栏中的“应用部署“。
2.  单击应用名称，进入应用详情页面。
3.  在“应用访问“页签下，单击“添加应用访问方式”。
4.  单击“添加”，配置应用访问方式。
    -   组件名称：选择对应的组件。
    -   对外协议：公网访问应用使用的协议，目前只支持HTTP。
    -   组件对外访问地址：请填写组件对外发布域名，域名需用户自行申请，并确保所填写域名能解析到所选负载均衡实例的服务地址。若不填写默认地址为负载均衡实例IP地址。
    -   对外端口：开放在负载均衡服务地址的端口。

5.  单击“确定”。设置完成后，即可访问数据库等一些中间件。

