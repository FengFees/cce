# 快照与备份<a name="cce_01_0211"></a>

-   [使用须知](#section113181948104715)
-   [使用场景](#section54641247195218)
-   [操作概览](#section1337153534815)
-   [创建快照](#section19431241165911)
-   [从快照创建云硬盘](#section1758441195914)
-   [删除快照](#section396113461706)
-   [相关操作](#section026133915118)
-   [参考文档](#section14627184153810)

CCE通过华为云[云硬盘EVS](https://support.huaweicloud.com/evs/index.html)服务为您提供快照功能，云硬盘快照简称快照，指云硬盘数据在某个时刻的完整拷贝或镜像，是一种重要的数据容灾手段，当数据丢失时，可通过快照将数据完整的恢复到快照时间点。

您可以创建快照，从而快速保存指定时刻云硬盘的数据。同时，您还可以通过快照创建新的云硬盘，这样云硬盘在初始状态就具有快照中的数据。

## 使用须知<a name="section113181948104715"></a>

-   快照功能**仅支持v1.15及以上版本**的集群，且需要安装基于CSI的[Everest插件](https://support.huaweicloud.com/usermanual-cce/cce_01_0066.html)才可以使用。
-   基于快照创建的云硬盘，其子类型（普通IO/高IO/超高IO）、是否加密、磁盘模式（VBD/SCSI）、共享性\(非共享/共享\)、容量等都要与快照关联母盘保持一致，这些属性查询和设置出来后不能够修改。

## 使用场景<a name="section54641247195218"></a>

快照功能可以帮助您实现以下需求：

-   **日常备份数据**

    通过对云硬盘定期创建快照，实现数据的日常备份，可以应对由于误操作、病毒以及黑客攻击等导致数据丢失或不一致的情况。

-   **快速恢复数据**

    更换操作系统、应用软件升级或业务数据迁移等重大操作前，您可以创建一份或多份快照，一旦升级或迁移过程中出现问题，可以通过快照及时将业务恢复到快照创建点的数据状态。

    例如，当由于云服务器 A的系统盘 A发生故障而无法正常开机时，由于系统盘 A已经故障，因此也无法将快照数据回滚至系统盘A。此时您可以使用系统盘 A已有的快照新创建一块云硬盘 B并挂载至正常运行的云服务器 B上，从而云服务器 B能够通过云硬盘 B读取原系统盘 A的数据。

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >当前CCE提供的快照能力与K8S社区CSI快照功能一致：只支持基于快照创建新云硬盘，不支持将快照回滚到源云硬盘。

-   **快速部署多个业务**

    通过同一个快照可以快速创建出多个具有相同数据的云硬盘，从而可以同时为多种业务提供数据资源。例如数据挖掘、报表查询和开发测试等业务。这种方式既保护了原始数据，又能通过快照创建的新云硬盘快速部署其他业务，满足企业对业务数据的多元化需求。


## 操作概览<a name="section1337153534815"></a>

1.  您可以[创建快照](#section19431241165911)，从而快速保存指定时刻云硬盘的数据。
2.  您可以[从快照创建云硬盘](#section1758441195914)，这样云硬盘在初始状态就具有快照中的数据，当数据丢失时，可通过快照将云硬盘数据完整的恢复到快照时间点。
3.  当快照不再使用时，可以[删除快照](#section396113461706)以释放虚拟资源。

## 创建快照<a name="section19431241165911"></a>

通过云硬盘可以创建快照，从而保存指定时刻的云硬盘数据。

>![](public_sys-resources/icon-note.gif) **说明：** 
>**只有可用或正在使用状态的云硬盘才能创建快照**，单个云硬盘最多支持创建7个快照。云硬盘创建请参见[云硬盘存储卷](云硬盘存储卷.md)。
>加密磁盘的快照数据以加密方式存放，非加密磁盘的快照数据以非加密方式存放。

**操作步骤：**

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“资源管理 \> 存储管理“。
2.  在“快照与备份“页签，单击“创建快照“。
3.  在打开的“创建快照“页面中，配置如[表1](#table195712416594)基本信息。

    **表 1**  创建快照基本信息配置

    <a name="table195712416594"></a>
    <table><thead align="left"><tr id="row95724185917"><th class="cellrowborder" valign="top" width="26%" id="mcps1.2.3.1.1"><p id="p105744115910"><a name="p105744115910"></a><a name="p105744115910"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="74%" id="mcps1.2.3.1.2"><p id="p1857194185919"><a name="p1857194185919"></a><a name="p1857194185919"></a>参数说明</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row1657144115592"><td class="cellrowborder" valign="top" width="26%" headers="mcps1.2.3.1.1 "><p id="p85719414598"><a name="p85719414598"></a><a name="p85719414598"></a>快照名称</p>
    </td>
    <td class="cellrowborder" valign="top" width="74%" headers="mcps1.2.3.1.2 "><p id="p55718418591"><a name="p55718418591"></a><a name="p55718418591"></a>新建快照的名称，默认以<span class="uicontrol" id="uicontrol167114477232"><a name="uicontrol167114477232"></a><a name="uicontrol167114477232"></a>“cce-disksnap-”</span>开头，样例：cce-disksnap-01</p>
    </td>
    </tr>
    <tr id="row1557341165911"><td class="cellrowborder" valign="top" width="26%" headers="mcps1.2.3.1.1 "><p id="p1957114125916"><a name="p1957114125916"></a><a name="p1957114125916"></a>集群名称</p>
    </td>
    <td class="cellrowborder" valign="top" width="74%" headers="mcps1.2.3.1.2 "><p id="p165784195917"><a name="p165784195917"></a><a name="p165784195917"></a>快照部署所在的集群。</p>
    </td>
    </tr>
    <tr id="row18574414594"><td class="cellrowborder" valign="top" width="26%" headers="mcps1.2.3.1.1 "><p id="p757241185913"><a name="p757241185913"></a><a name="p757241185913"></a>命名空间</p>
    </td>
    <td class="cellrowborder" valign="top" width="74%" headers="mcps1.2.3.1.2 "><p id="p55784195910"><a name="p55784195910"></a><a name="p55784195910"></a>选择对应的命名空间。</p>
    </td>
    </tr>
    <tr id="row1457124155912"><td class="cellrowborder" valign="top" width="26%" headers="mcps1.2.3.1.1 "><p id="p105764115595"><a name="p105764115595"></a><a name="p105764115595"></a>选择存储</p>
    </td>
    <td class="cellrowborder" valign="top" width="74%" headers="mcps1.2.3.1.2 "><p id="p05774112594"><a name="p05774112594"></a><a name="p05774112594"></a><span>选择创建快照的云硬盘，即</span>已创建的云硬盘存储卷。</p>
    <p id="p85724113595"><a name="p85724113595"></a><a name="p85724113595"></a>只有可用或正在使用状态的磁盘才能创建快照。磁盘创建请参见<a href="云硬盘存储卷.md">云硬盘存储卷</a>。</p>
    </td>
    </tr>
    </tbody>
    </table>

4.  单击“立即创建”。
5.  单击“返回快照管理“，当快照状态为“正常”时，表示创建成功。

    单击快照名称前的![](figures/zh-cn_image_0213878870.png)，可查看快照的状态和详细信息。


## 从快照创建云硬盘<a name="section1758441195914"></a>

您可以在快照列表页面，选择快照用来创建云硬盘数据卷。

通过快照创建云硬盘数据卷时，有以下约束：

-   通过快照创建云硬盘数据卷时，磁盘类型、磁盘模式、加密属性需和快照源云硬盘保持一致。
-   一个快照最多支持创建128个云硬盘数据卷。
-   从快照创建云硬盘数据卷时，不支持批量创建，数量只能为“1”。

**操作步骤：**

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“资源管理 \> 存储管理“。
2.  单击“快照与备份“页签，在快照列表中，找到指定快照并单击快照所在行的“操作”列下的“创建数据卷”。
3.  设置云硬盘数据卷的各项参数。具体请参见[云硬盘存储卷](云硬盘存储卷.md)。

    通过快照创建云硬盘数据卷时，容量大小不能低于快照大小。当您未指定云硬盘数据卷的容量时，当快照大小容量低于10GB，默认容量为10GB，当快照大小高于10GB，默认容量和快照大小保持一致。

4.  单击“立即购买”。
5.  根据界面提示付款，单击“提交”。
6.  在“任务提交成功“页面，单击“返回存储卷列表“，在“云硬盘存储卷”页签下，查看云硬盘存储卷的状态。

    待云硬盘存储卷状态变为“正常”时，表示创建成功。


## 删除快照<a name="section396113461706"></a>

当快照不再使用时，您可以删除快照以释放虚拟资源，删除快照有以下约束：

-   当快照状态为“正常”或者“错误”时，才可以删除快照。
-   如果将创建快照的云硬盘存储卷删除，那么对应的快照也会被同时删除。

**操作步骤：**

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“资源管理 \> 存储管理“。
2.  单击“快照与备份“页签，在快照列表中，找到指定快照并单击快照所在行的“操作”列下的“删除”。
3.  \(可选\) 如果需要删除多个快照，可勾选![](figures/zh-cn_image_0213897379.png)选中多个快照，单击快照列表左上方的“删除”按钮。
4.  在弹出对话框中，确认删除信息并输入**DELETE**后，单击“是”进行删除。

## 相关操作<a name="section026133915118"></a>

云硬盘快照常见问题请参见[云硬盘快照问题](https://support.huaweicloud.com/evs_faq/evs_01_0092.html)。

## 参考文档<a name="section14627184153810"></a>

-   [Volume Snapshots](https://kubernetes.io/docs/concepts/storage/volume-snapshots/#lifecycle-of-a-volume-snapshot-and-volume-snapshot-content)

