# 云原生网络2.0<a name="cce_01_0284"></a>

## 云原生网络2.0网络模型<a name="section18112145311217"></a>

云原生网络2.0是自研的新一代容器网络模型，深度整合了虚拟私有云VPC的弹性网卡（Elastic Network Interface，简称ENI）和辅助弹性网卡（Sub Network Interface，简称Sub-ENI）的能力，直接从VPC网段内分配容器IP地址，支持ELB直通容器，绑定安全组，绑定弹性公网IP，享有高性能。

**图 1**  云原生网络2.0<a name="zh-cn_topic_0146398798_fig117435555917"></a>  
![](figures/云原生网络2-0.png "云原生网络2-0")

**说明如下：**

-   节点内Pod间通信：直接通过VPC的弹性网卡/弹性辅助网卡进行流量转发。
-   跨节点Pod间通信：直接通过VPC的弹性网卡/弹性辅助网卡进行流量转发。

## 约束与限制<a name="section2548184716433"></a>

-   CCE Turbo集群使用云原生网络2.0。
-   CCE Turbo集群中节点上的弹性网卡ENI会被网络管理组件接管，若用户有使用弹性网卡ENI的诉求，需要[提交工单](https://console.huaweicloud.com/ticket/#/ticketindex/createIndex)开放。

## 云原生网络2.0容器网段规划<a name="section08181419115517"></a>

云原生网络2.0采用与集群节点相同VPC下的不同子网作为容器子网。

**图 2**  网段配置<a name="fig16639123813259"></a>  
![](figures/网段配置.png "网段配置")

规划容器网段的可分配IP数应至少大于集群下各个节点的负载实例上限之和。

## 容器IP地址管理<a name="section45181754101115"></a>

云原生网络2.0下的BMS节点和ECS节点分别使用的是弹性网卡和辅助弹性网卡，它们的IP地址管理如下图所示：

**图 3**  云原生网络2.0的IP地址管理<a name="fig187842468716"></a>  
![](figures/云原生网络2-0的IP地址管理.png "云原生网络2-0的IP地址管理")

-   Pod的IP地址从配置给容器子网的VPC子网上分配。
-   ECS节点上绑定的总的弹性网卡和辅助弹性网卡数： 用于承载辅助弹性网卡的弹性网卡数 + 当前Pod使用的辅助弹性网卡数 + 预绑定的辅助弹性网卡数 。
-   ECS节点上当前预绑定辅助弹性网卡数 + 当前Pod使用的辅助弹性网卡数 < 最小预绑定辅助弹性网卡数时，会绑定辅助弹性网卡使得预绑定辅助弹性网卡数+当前Pod使用的辅助弹性网卡 = 最小预绑定辅助弹性网卡数。
-   ECS节点上当前预绑定辅助弹性网卡数 + 当前Pod使用的辅助弹性网卡数 \> 最大预绑定辅助弹性网卡数，会定时释放弹性辅助网卡（约2分钟一次），直到预绑定辅助弹性网卡数+当前Pod使用的辅助弹性网卡 = 最大预绑定辅助弹性网卡数。
-   BMS节点上绑定的弹性网卡数：当前Pod使用的弹性网卡数 +  预绑定的弹性网卡数 。
-   BMS节点上当预绑定弹性网卡数 + 当前Pod使用的弹性网卡数 < 最小预绑定弹性网卡数时，会绑定弹性网卡使得预绑定弹性网卡数 + 当前Pod使用的弹性网卡数 = 最小预绑定弹性网卡数。
-   BMS节点上当预绑定弹性网卡数 + 当前Pod使用的弹性网卡数 \> 最大预绑定弹性网卡数，会定时释放弹性网卡（约2分钟一次），直到预绑定弹性网卡数 + 当前Pod使用的弹性网卡数 = 最大预绑定弹性网卡数。

## 适用场景<a name="section3723244144011"></a>

-   性能要求高，需要使用VPC其他网络能力的场景：由于云原生网络2.0直接使用的VPC网络，性能与VPC网络的性能几乎一致，所以适用于对带宽、时延要求极高的业务场景，比如：线上直播、电商秒杀等。
-   大规模组网：云原生网络2.0当前最大可支持2000个ECS节点，10万个容器。

## 最佳实践<a name="section18716143811272"></a>

[CCE Turbo共池BMS节点容器网卡多队列配置](https://support.huaweicloud.com/bestpractice-cce/cce_bestpractice_0017.html)

## 常见问题<a name="section152643614445"></a>

[CCE Turbo裸机BMS节点上Pod启动慢，如何排查？](https://support.huaweicloud.com/cce_faq/cce_faq_00310.html)

## 云原生网络2.0访问示例<a name="section161713314914"></a>

创建一个CCE Turbo集群，集群包含3个ECS节点。

**图 4**  集群网络<a name="fig34706594193"></a>  
![](figures/集群网络-18.png "集群网络-18")

**图 5**  节点列表<a name="fig12441149202012"></a>  
![](figures/节点列表-19.png "节点列表-19")

进入其中一个节点，可以看到节点有一个主网卡和扩展网卡，这两个网卡都是弹性网卡，其中扩展网卡是属于容器网络网段，用于给Pod挂载辅助弹性网卡Sub-ENI。

**图 6**  节点网卡<a name="fig9242131819209"></a>  
![](figures/节点网卡.png "节点网卡")

在集群中创建一个Deployment。

```
kind: Deployment
apiVersion: apps/v1
metadata:
  name: example
  namespace: default
spec:
  replicas: 6
  selector:
    matchLabels:
      app: example
  template:
    metadata:
      labels:
        app: example
    spec:
      containers:
        - name: container-0
          image: 'nginx:perl'
          resources:
            limits:
              cpu: 250m
              memory: 512Mi
            requests:
              cpu: 250m
              memory: 512Mi
      imagePullSecrets:
        - name: default-secret
```

创建后查询Pod。

```
$ kubectl get pod -owide
NAME                       READY   STATUS    RESTARTS   AGE   IP            NODE         NOMINATED NODE   READINESS GATES
example-5bdc5699b7-54v7g   1/1     Running   0          7s    10.1.18.2     10.1.0.167   <none>           <none>
example-5bdc5699b7-6dzx5   1/1     Running   0          7s    10.1.18.216   10.1.0.186   <none>           <none>
example-5bdc5699b7-gq7xs   1/1     Running   0          7s    10.1.16.63    10.1.0.144   <none>           <none>
example-5bdc5699b7-h9rvb   1/1     Running   0          7s    10.1.16.125   10.1.0.167   <none>           <none>
example-5bdc5699b7-s9fts   1/1     Running   0          7s    10.1.16.89    10.1.0.144   <none>           <none>
example-5bdc5699b7-swq6q   1/1     Running   0          7s    10.1.17.111   10.1.0.167   <none>           <none>
```

这里Pod的IP都是Sub-ENI，挂载在节点的ENI上（扩展网卡）。

例如10.1.0.167节点对应的扩展网卡是10.1.17.172。在弹性网卡控制台上可以看到10.1.17.172这块扩展网卡挂载3个Sub-ENI，正是Pod的IP。

**图 7**  Pod网卡<a name="fig03652819204"></a>  
![](figures/Pod网卡.png "Pod网卡")

在VPC中直接访问Pod的IP，能够正常访问。

