# 云原生网络2.0<a name="cce_01_0284"></a>

-   [约束与限制](#section2548184716433)
-   [优势](#section97761310143015)
-   [适用场景](#section3723244144011)
-   [云原生网络2.0容器网段规划](#section08181419115517)
-   [通过Kubectl调整裸金属节点网卡预热状态](#section8392727628)

云原生网络2.0是华为云自研的新一代容器网络模型，深度整合了华为云[虚拟私有云VPC](https://support.huaweicloud.com/vpc/index.html)的原生弹性网卡（Elastic Network Interface，简称ENI）能力，采用VPC网段分配容器地址，支持ELB直通容器，享有高性能。

**图 1**  云原生网络2.0<a name="zh-cn_topic_0146398798_fig117435555917"></a>  
![](figures/云原生网络2-0.png "云原生网络2-0")

**云原生网络2.0包括4个组件：**

-   yangtse-apiserver

    提供云原生网络2.0内部资源对象（Node，DistNodeSubnet，NeutronPort，Network，Subnet）等资源的REST操作接口，供yangtse-controller，yangtse-agent进行调用。

-   yangtse-controller

    是云原生网络2.0的核心，它通过对yangtse-apiserver以及kube-apiserver特定资源进行list&watch，将当前的状态向期望的状态迁移并最终一致；目前包括NAD控制器、DistNodeSubnet控制器、ENI Pod控制器、Node控制器、NeutronPort控制器、Accelerator控制器、Recycler控制器、PodNetworkInterface控制器、NetworkPolicy控制器等控制器。

-   yangtse-cni

    实现了CNI标准规范的二进制插件，作为kubelet与yangtse-agent之间的调用代理。

-   yangtse-agent

    是运行在每个节点上的守护进程，yangtse-agent启动的时候，会向yangtse-apiserver注册该节点；yangtse-agent也需要对特定的资源进行list&watch进行控制调谐，包括Network控制器、NeutronPort控制器；同时作为server响应yangtse-cni的容器网络Add/Del请求。


## 约束与限制<a name="section2548184716433"></a>

-   仅CCE Turbo集群支持使用该功能。
-   CCE Turbo集群中使用了弹性网卡的能力，单节点部署的容器数量受限于ECS节点的网卡个数上限，详情请参见ECS的[规格清单](https://support.huaweicloud.com/productdesc-ecs/zh-cn_topic_0159822360.html)。
-   CCE Turbo集群默认不预留网卡，即CCE节点上的ENI网卡会被网络管理组件接管，若用户有使用ENI的诉求，需要[提交工单](https://console.huaweicloud.com/ticket/#/ticketindex/createIndex)开放。

## 优势<a name="section97761310143015"></a>

-   灵活迁移

    通过将弹性网卡从云服务器实例解绑后再绑定到另外一台服务器实例，保留已绑定私网IP、弹性公网IP和安全组策略，无需重新配置关联关系，将故障实例上的业务流量快速迁移到备用实例，实现服务快速恢复。

-   业务分离管理

    可以为服务器实例配置多个分属于同一VPC内不同子网的弹性网卡，特定网卡分别承载云服务器实例的内网、外网、管理网流量。针对子网可独立设置访问安全控制策略与路由策略，弹性网卡也可配置独立安全组策略，从而实现网络隔离与业务流量分离。


## 适用场景<a name="section3723244144011"></a>

-   适用于对网络时延、带宽要求高的高性能场景。
-   容器与虚机IP互通，使用了微服务注册框架的，如Dubbo、Spring Cloud等。

## 云原生网络2.0容器网段规划<a name="section08181419115517"></a>

-   云原生网络2.0采用与集群相同VPC下的不同子网作为容器网段。

    ![](figures/zh-cn_image_0000001083190800.png)

-   规划容器网段的可分配IP数应至少大于集群下各个节点的负载实例上限之和。
    1.  节点负载实例数大于容器网段IP数，造成节点资源浪费。
    2.  预热ENI网卡占用容器网段IP。


## 通过Kubectl调整裸金属节点网卡预热状态<a name="section8392727628"></a>

1.  登录已配置好kubectl命令的弹性云服务器。登录方法请参见[登录Linux弹性云服务器](https://support.huaweicloud.com/usermanual-ecs/zh-cn_topic_0013771089.html)。
2.  编辑对应节点的yaml。
3.  修改ENI网卡预热参数。

    ![](figures/zh-cn_image_0000001130030201.png)

    **表 1**  关键参数说明

    <a name="table6573122711216"></a>
    <table><thead align="left"><tr id="row1157212271924"><th class="cellrowborder" valign="top" width="24.772477247724773%" id="mcps1.2.5.1.1"><p id="p175723276212"><a name="p175723276212"></a><a name="p175723276212"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="13.691369136913693%" id="mcps1.2.5.1.2"><p id="p25722278215"><a name="p25722278215"></a><a name="p25722278215"></a>是否必填</p>
    </th>
    <th class="cellrowborder" valign="top" width="13.821382138213819%" id="mcps1.2.5.1.3"><p id="p25726277218"><a name="p25726277218"></a><a name="p25726277218"></a>参数类型</p>
    </th>
    <th class="cellrowborder" valign="top" width="47.714771477147714%" id="mcps1.2.5.1.4"><p id="p1457210276212"><a name="p1457210276212"></a><a name="p1457210276212"></a>描述</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row15572122712213"><td class="cellrowborder" valign="top" width="24.772477247724773%" headers="mcps1.2.5.1.1 "><p id="p17572827922"><a name="p17572827922"></a><a name="p17572827922"></a>nic-multiqueue</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.691369136913693%" headers="mcps1.2.5.1.2 "><p id="p125721927627"><a name="p125721927627"></a><a name="p125721927627"></a>是</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.821382138213819%" headers="mcps1.2.5.1.3 "><p id="p7572227126"><a name="p7572227126"></a><a name="p7572227126"></a><a href="#table16175413105111">表2 nic-multiqueue字段数据结构说明</a></p>
    <p id="p05721627226"><a name="p05721627226"></a><a name="p05721627226"></a>Object</p>
    </td>
    <td class="cellrowborder" valign="top" width="47.714771477147714%" headers="mcps1.2.5.1.4 "><p id="p857214271027"><a name="p857214271027"></a><a name="p857214271027"></a>预热网卡的队列数与比例。</p>
    </td>
    </tr>
    <tr id="row10573192714211"><td class="cellrowborder" valign="top" width="24.772477247724773%" headers="mcps1.2.5.1.1 "><p id="p15721271721"><a name="p15721271721"></a><a name="p15721271721"></a>nic-threshold</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.691369136913693%" headers="mcps1.2.5.1.2 "><p id="p1557212271421"><a name="p1557212271421"></a><a name="p1557212271421"></a>是</p>
    </td>
    <td class="cellrowborder" valign="top" width="13.821382138213819%" headers="mcps1.2.5.1.3 "><p id="p1557215273214"><a name="p1557215273214"></a><a name="p1557215273214"></a>String</p>
    </td>
    <td class="cellrowborder" valign="top" width="47.714771477147714%" headers="mcps1.2.5.1.4 "><p id="p12573112713220"><a name="p12573112713220"></a><a name="p12573112713220"></a>预热网卡的高低水位。</p>
    <p id="p2057313275217"><a name="p2057313275217"></a><a name="p2057313275217"></a>低水位：当预热网卡数小于（低水位*ENI网卡配额）时，节点会自动预热到（低水位*ENI网卡配额的网卡）数。</p>
    <p id="p1257318272217"><a name="p1257318272217"></a><a name="p1257318272217"></a>高水位：当节点预热网卡数大于（高水位*ENI网卡配额）时，节点会自动解绑一部分网卡，直至ENI网卡数小于等于（高水位*ENI网卡配额）。</p>
    <p id="p8573127126"><a name="p8573127126"></a><a name="p8573127126"></a>取值范围：</p>
    <p id="p1957313276213"><a name="p1957313276213"></a><a name="p1957313276213"></a>1. 必须为一位小数</p>
    <p id="p11573227029"><a name="p11573227029"></a><a name="p11573227029"></a>2. 0 &lt;= 低水位&lt;=高水位&lt;=1</p>
    </td>
    </tr>
    </tbody>
    </table>

    **表 2**  nic-multiqueue字段数据结构说明

    <a name="table115747271226"></a>
    <table><thead align="left"><tr id="row95731278218"><th class="cellrowborder" valign="top" width="24.612461246124614%" id="mcps1.2.5.1.1"><p id="p757372715213"><a name="p757372715213"></a><a name="p757372715213"></a>参数</p>
    </th>
    <th class="cellrowborder" valign="top" width="14.481448144814483%" id="mcps1.2.5.1.2"><p id="p15573122711210"><a name="p15573122711210"></a><a name="p15573122711210"></a>是否必填</p>
    </th>
    <th class="cellrowborder" valign="top" width="15.771577157715772%" id="mcps1.2.5.1.3"><p id="p125731127325"><a name="p125731127325"></a><a name="p125731127325"></a>参数类型</p>
    </th>
    <th class="cellrowborder" valign="top" width="45.13451345134513%" id="mcps1.2.5.1.4"><p id="p1757316271727"><a name="p1757316271727"></a><a name="p1757316271727"></a>描述</p>
    </th>
    </tr>
    </thead>
    <tbody><tr id="row11573122712214"><td class="cellrowborder" valign="top" width="24.612461246124614%" headers="mcps1.2.5.1.1 "><p id="p957392716219"><a name="p957392716219"></a><a name="p957392716219"></a>queue</p>
    </td>
    <td class="cellrowborder" valign="top" width="14.481448144814483%" headers="mcps1.2.5.1.2 "><p id="p757372714220"><a name="p757372714220"></a><a name="p757372714220"></a>是</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.771577157715772%" headers="mcps1.2.5.1.3 "><p id="p1857332719211"><a name="p1857332719211"></a><a name="p1857332719211"></a>int</p>
    </td>
    <td class="cellrowborder" valign="top" width="45.13451345134513%" headers="mcps1.2.5.1.4 "><p id="p857316273210"><a name="p857316273210"></a><a name="p857316273210"></a>预热网卡的队列数，队列数越多性能越强，但能够创建的网卡总量越少</p>
    <p id="p9573172715216"><a name="p9573172715216"></a><a name="p9573172715216"></a>取值范围：1/2/4/8/16/28</p>
    </td>
    </tr>
    <tr id="row25747271223"><td class="cellrowborder" valign="top" width="24.612461246124614%" headers="mcps1.2.5.1.1 "><p id="p10573122717212"><a name="p10573122717212"></a><a name="p10573122717212"></a>factor</p>
    </td>
    <td class="cellrowborder" valign="top" width="14.481448144814483%" headers="mcps1.2.5.1.2 "><p id="p5573122710214"><a name="p5573122710214"></a><a name="p5573122710214"></a>是</p>
    </td>
    <td class="cellrowborder" valign="top" width="15.771577157715772%" headers="mcps1.2.5.1.3 "><p id="p135731627325"><a name="p135731627325"></a><a name="p135731627325"></a>float</p>
    </td>
    <td class="cellrowborder" valign="top" width="45.13451345134513%" headers="mcps1.2.5.1.4 "><p id="p165731827621"><a name="p165731827621"></a><a name="p165731827621"></a>总预热网卡数下各个队列网卡数所占比例。</p>
    <p id="p155731727125"><a name="p155731727125"></a><a name="p155731727125"></a>例如：nic-multiqueue:[{"queue":1,"factor":0.6},{"queue":2,"factor":0.4}]，当节点有128张预热的ENI网卡，那么一队列网卡预热0.6*128=76张，而队列网卡预热51张。</p>
    <p id="p857410271212"><a name="p857410271212"></a><a name="p857410271212"></a>取值范围：</p>
    <p id="p145743279219"><a name="p145743279219"></a><a name="p145743279219"></a>1. factor必须为一位小数；</p>
    <p id="p1257432711218"><a name="p1257432711218"></a><a name="p1257432711218"></a>2. 所有factor之和必须为1；</p>
    </td>
    </tr>
    </tbody>
    </table>


