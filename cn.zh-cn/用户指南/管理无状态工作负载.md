# 管理无状态工作负载<a name="cce_01_0007"></a>

无状态工作负载创建后，您可以对其执行伸缩、升级、编辑YAML、日志、监控、回退、删除等操作。

## 工作负载日志<a name="section51511928173817"></a>

您可以通过“日志“功能查看无状态工作负载的日志信息。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击工作负载后的“日志“。

    在弹出的“日志“窗口中可以查看最近5分钟、最近30分钟、最近1小时内的日志信息。

    **图 1**  查看无状态工作负载日志<a name="fig48869171302"></a>  
    ![](figures/查看无状态工作负载日志.png "查看无状态工作负载日志")

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >云容器引擎服务对接了应用运维管理服务AOM提供日志查看、检索功能。华为云于2019年10月10日对应用运维管理服务进行价格调整，每月赠送租户500M免费日志采集额度，超过免费额度部分将产生费用（[了解计费详情](https://www.huaweicloud.com/notice/2018/20190929175154404.html)）。当前日志使用情况请[点此查看](https://console.huaweicloud.com/aom/#/aom/als/setting)。  


## 工作负载升级<a name="section17604174417381"></a>

基于CCE，您可以通过更换镜像或镜像版本实现工作负载的快速升级，业务无中断。

若需要更换镜像或镜像版本，您需要提前将镜像上传到容器镜像服务，上传方法请参见[通过Docker客户端上线镜像](https://support.huaweicloud.com/usermanual-swr/swr_01_0011.html)。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”，单击待升级工作负载后的“升级“。
2.  请根据业务需求进行工作负载的升级。
    -   **镜像名称：**单击“更换镜像”，选择新的镜像。

        **图 2**  更换镜像<a name="fig1357692952713"></a>  
        ![](figures/更换镜像.png "更换镜像")

    -   **镜像版本：**在镜像版本后的下拉框中选择对应版本。

        **图 3**  更换镜像版本<a name="fig1398154962812"></a>  
        ![](figures/更换镜像版本.png "更换镜像版本")

    -   **容器名称：**单击容器名称后的![](figures/icon-edit.png)，修改容器名称。
    -   **特权容器：**开启后，容器将可以访问主机上的所有设备。
    -   **容器规格：**可分别设置CPU配额、内存配额、GPU配额和D芯片配额。
    -   **高级设置：**
        -   **生命周期：**用于设置容器启动和运行时需要执行的命令。
            -   启动命令：设置容器启动时执行的命令，详情请参见[设置容器启动命令](设置容器启动命令.md)。
            -   启动后处理：设置容器成功运行后执行的命令，详细配置方法请参见[设置容器生命周期](设置容器生命周期.md)。
            -   停止前处理：设置容器结束前执行的命令，通常用于删除日志/临时文件等，详细配置方法请参见[设置容器生命周期](设置容器生命周期.md)。

        -   **健康检查：**CCE提供了存活与业务两种探针，用于判断容器和用户业务是否正常运行。详细配置方法请参见[设置容器健康检查](设置容器健康检查.md)。
            -   工作负载存活探针：检查容器是否正常，不正常则重启实例。
            -   工作负载业务探针：检查用户业务是否就绪，不就绪则不转发流量到当前实例。

        -   **环境变量：**在容器中添加环境变量，一般用于通过环境变量设置参数。

            在“环境变量“页签，单击“添加环境变量“，当前支持三种类型：

            -   手动添加：输入变量名称、变量/变量引用。
            -   密钥导入：输入变量名称，选择导入的密钥名称和数据。您需要提前创建密钥，详情请参见[创建密钥](创建密钥.md)。
            -   配置项导入：输入变量名称，选择导入的配置项名称和数据。您需要提前创建配置项，详情请参见[创建配置项](创建配置项.md)。

                >![](public_sys-resources/icon-note.gif) **说明：**   
                >对于已设置的环境变量，单击环境变量后的“编辑”，可对该环境变量进行编辑。单击环境变量后的“删除”，可删除该环境变量。  


        -   **数据存储：**给容器挂载数据存储，支持本地磁盘和云存储，适用于需持久化存储、高磁盘IO等场景。详情请参见[使用本地磁盘存储](使用本地磁盘存储.md)、[使用文件存储卷](使用文件存储卷.md)、[使用对象存储卷](使用对象存储卷.md)、[使用极速文件存储卷](使用极速文件存储卷.md)。
        -   **安全设置：**对容器权限进行设置，保护系统和其他容器不受其影响。

            请输入用户ID，容器将以当前用户权限运行。

        -   **容器日志：**设置容器日志采集策略、配置日志目录。用于收集容器日志便于统一管理和分析。详细配置请参见[采集容器标准输出日志](采集容器标准输出日志.md)、[采集容器内路径日志](采集容器内路径日志.md)。

3.  更新完成后，单击“提交“。

## 编辑YAML<a name="section21669213390"></a>

可通过在线YAML编辑窗对工作负载的YAML文件进行修改和下载。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击工作负载后的“更多 \> 编辑YAML“，在弹出的“编辑YAML“窗中可对当前工作负载的YAML文件进行修改。
3.  单击“修改“，在弹出的提示框中单击“确定“，完成修改。
4.  （可选）在“编辑YAML“窗中，单击“下载“，可下载该YAML文件。

## 工作负载伸缩<a name="section11703514131711"></a>

您可以根据业务需求自行定义工作负载的伸缩策略，降低因应对业务变化和高峰压力而人为反复调整资源的工作量，帮助您节约资源和人力成本。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击待设置伸缩策略工作负载后的“更多 \> 伸缩“，进入工作负载详情页面。
3.  在“伸缩“页签，可设置“弹性伸缩“和“手动伸缩“策略，或“编辑伸缩规则“。详细设置方法请参见[工作负载伸缩](工作负载伸缩.md)。

## 工作负载监控<a name="section15303324141816"></a>

您可以通过CCE控制台查看工作负载的CPU和内存占用情况，以确定需要的资源规格。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击已创建工作负载的名称，进入工作负载详情页面。在监控页签，可查看工作负载的CPU利用率和内存利用率。
3.  单击“实例列表”，单击某个实例名称前的![](figures/下拉框.png)，单击“监控“。
4.  查看相应实例的CPU使用率、内存使用率。
    -   CPU使用率。

        横坐标表示时间，纵坐标表示CPU使用率。绿色线条表示CPU使用率，红色线条表示CPU使用限额。

        >![](public_sys-resources/icon-note.gif) **说明：**   
        >CPU使用量需要计算，故初次显示时，CPU使用量会比内存使用量晚一分钟左右显示。  
        >只有实例处于运行状态时，才能查看CPU使用量。  

    -   物理内存使用率。

        横坐标表示时间，纵坐标表示内存使用量。绿色线条表示内存使用率，红色线条表示内存使用限额。

        >![](public_sys-resources/icon-note.gif) **说明：**   
        >实例处于非运行状态时，无法查看内存使用量。  



## 工作负载回退<a name="section13324541124815"></a>

所有无状态工作负载的发布历史记录都保留在系统中，您可以回退到指定的版本。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击待回退工作负载后的“更多 \> 回退“。
3.  在“回退到该版本“后，选择回退版本，单击“确定“。

## 工作负载暂停<a name="section10207209154017"></a>

无状态工作负载可以进行暂停操作。暂停后，对负载进行的升级操作可以正常下发，但不会被应用到实例。

如果您正在滚动升级的过程中，滚动升级会在暂停命令下发后停止，出现新旧实例共存的状态。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击待暂停的工作负载后方操作栏中的“更多 \> 暂停”。
3.  在弹出的负载暂停信息提示框中，单击“确认”。
4.  单击“确定”，可完成暂停操作。

    >![](public_sys-resources/icon-notice.gif) **须知：**   
    >工作负载状态为暂停中时无法执行回退操作。  


## 工作负载恢复<a name="section12087915401"></a>

暂停中的负载可以进行恢复操作。恢复后，负载可以正常升级和回退，负载下的实例会与负载当前的最新信息进行一次同步，如果有不一致的，则会自动按照负载的最新信息进行升级。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击待暂停的工作负载后方操作栏中的“更多 \> 恢复”。
3.  在弹出的负载恢复信息提示框中，单击“确认”。

## 工作负载标签管理<a name="section5931193015488"></a>

标签是以key/value键值对的形式附加在工作负载上的。添加标签后，可通过标签对工作负载进行管理和选择，主要用于设置亲和性与反亲和性调度。您可以给多个工作负载打标签，也可以给指定的某个工作负载打标签。

如下图，假设为工作负载（例如名称为APP1、APP2、APP3）定义了3个标签：release、env、role。不同工作负载定义了不同的取值，分别为：

-   APP 1：\[release:alpha;env:development;role:frontend\]
-   APP 2：\[release:beta;env:testing;role:frontend\]
-   APP 3：\[release:alpha;env:production;role:backend\]

在使用调度或其他功能时，选择“key/value“值分别为“role/frontend“的工作负载，则会选择到“APP1和APP2“。

**图 4**  标签案例<a name="ff50c8d071f4d462bb116f4e3d67c131c"></a>  
![](figures/标签案例.png "标签案例")

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击待添加标签的工作负载，进入工作负载详情页面。
3.  单击“标签管理“，单击“添加标签“，输入键和值，单击“确定“。

    **图 5**  标签管理<a name="fig293972414341"></a>  
    ![](figures/标签管理.png "标签管理")

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >标签格式要求如下：以字母和数字开头或结尾，由字母、数字、连接符（-）、下划线（\_）、点号（.）组成且63字符以内。  


## 删除工作负载<a name="section14423721191418"></a>

若工作负载无需再使用，您可以将工作负载删除。工作负载删除后，将无法恢复，请谨慎操作。

1.  登录[CCE控制台](https://console.huaweicloud.com/cce2.0/?utm_source=helpcenter)，在左侧导航栏中选择“工作负载 \> 无状态（Deployment）”。
2.  单击待删除工作负载后的“更多 \> 删除“，删除工作负载。

    请仔细阅读系统提示。

3.  单击“确定“。

