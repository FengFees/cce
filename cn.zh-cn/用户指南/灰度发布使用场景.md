# 灰度发布使用场景<a name="cce_01_0050"></a>

灰度发布是迭代的软件产品在生产环境安全上线的一种重要手段。本章指导您使用服务网格技术实现灰度发布的几种场景。

服务网格基于Istio提供的服务治理能力，对服务提供多版本支持和灵活的流量策略，从而支持多种灰度发布场景。

当前版本支持金丝雀发布和蓝绿发布，ABTest和自定义即将开放，敬请期待。

## 前提条件<a name="section77301553236"></a>

已创建应用，且服务中已有一个生产版本在线，例如版本号为v1。详细步骤请参见[创建应用](创建应用.md)。

## 金丝雀发布<a name="section18766329162914"></a>

在生产环境上引一部分实际流量对一个新版本进行测试，测试新版本的性能和表现，在保证系统整体稳定运行的前提下，尽早发现新版本在实际环境上的问题。

**金丝雀发布的特点：**

通过在线上运行的服务中，新加入少量的新版本的服务，然后从这少量的新版本中快速获得反馈，根据反馈决定最后的交付形态。

## 蓝绿发布<a name="section82561111111"></a>

蓝绿发布提供了一种零宕机的部署方式。不停老版本，部署新版本进行测试，确认OK，将流量切到新版本，然后老版本同时也升级到新版本。始终有两个版本同时在线，有问题可以快速切换。

**蓝绿发布的特点是：**在部署应用的过程中，应用始终在线。并且新版本上线过程中，不会修改老版本的任何内容，在部署期间老版本状态不受影响。只要老版本的资源不被删除，可以在任何时间回滚到老版本。

**操作步骤：**

1.  在CCE左侧导航栏中选择“应用治理“，打开[应用服务网格控制台](https://console.huaweicloud.com/istio/)，单击左侧导航栏中的“灰度发布“，在蓝绿发布下单击“创建”。
2.  配置灰度版本基本信息。
    -   蓝绿发布组件：单击“选择组件”，选择待发布组件，目前只支持对只有一个组件访问端口、且访问协议设置为http的组件进行灰度发布。
    -   发布任务名称：系统自动生成，可根据实际需求进行修改。
    -   版本号：新增服务中灰度版本号。

    -   版本描述：灰度版本描述信息。

3.  根据界面提示的流程图，熟悉灰度发布版本流程，单击“创建”。
4.  部署灰度版本。
    -   实例数量：灰度版本的实例数量。灰度版本可以有一个或多个实例，用户可根据实际需求进行修改。每个灰度版本的实例都由相同的容器部署而成。
    -   镜像名称：默认为该组件的镜像。
    -   镜像版本：请选择需要添加灰度的镜像版本。
    -   配置高级设置。默认继承已有灰度版本的配置，若新建灰度版本有特殊要求，可进行修改。
        -   资源分配：单击![](figures/icon-edit-5.png)可更改申请和限制的配额。申请和限制的含义如下。详细请参见[设置容器规格](设置容器规格.md)。
            -   申请：表示应用运行所需最少资源。
            -   限制：若担心应用超载，导致系统故障。建议设置应用配额的最高限制。确保应用资源不会超额。

        -   环境变量：

            在“环境变量“页签，单击“添加环境变量“。当前支持三种类型。

            -   手动添加：输入变量名称、变量/变量引用。
            -   密钥导入：输入变量名称，选择导入的密钥名称和数据。您需要提前创建密钥，详情请参见[创建密钥](创建密钥.md)。
            -   配置项导入：输入变量名称，选择导入的配置项名称和数据。您需要提前创建配置项，详情请参见[创建配置项](创建配置项.md)。

        -   健康检查：用于判断容器和用户业务是否正常运行。设置了存活与业务两种探针。详细配置方法同[容器健康检查](容器健康检查.md)。
            -   应用存活探针：监测到容器实例不健康时，重启应用。
            -   应用业务探针：监测到容器实例不健康时，将工作负载设置为未就绪状态，业务流量不会导入到该容器中。

        -   数据存储：给容器挂载数据存储，适用于需持久化存储、高磁盘IO等场景。详细配置请参见[存储管理](存储管理.md)。
        -   容器日志：设置容器日志采集策略、配置日志目录。用于收集容器日志便于统一管理和分析。详细配置请参见[日志管理](日志管理.md)。
        -   生命周期：用于管理容器各阶段需要执行的命令。
            -   启动命令：设置容器启动时执行的命令。详情请参见[设置容器启动命令](设置容器启动命令.md)。
            -   启动后处理：设置容器成功运行后执行的命令。详细配置方法请参见[设置容器生命周期](设置容器生命周期.md)。
            -   停止前处理：设置容器结束前执行的命令，通常用于删除日志/临时文件等。详细配置方法请参见[设置容器生命周期](设置容器生命周期.md)。



5.  单击“部署新版本“，新版本开始创建。

## A/B Testing<a name="section972381761119"></a>

当产品已经相对稳定，已经上线并有一定数量的用户在使用时，企业会面临一个压力：任何的更新或者优化是否一定比原来更好？

**A/B Testing的特点是：**通过A/B Testing可以帮助企业对新版本进行测试验证。针对新上线的版本配置一定的引流规则，将少量用户的访问流量引入到新版本。通过访问样本的评估以及数据分析，评价该版本被接受的程度，确定是否需要将全部流量切到该版本上。

