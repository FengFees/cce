# 灰度发布使用场景<a name="cce_01_0050"></a>

灰度发布是迭代的软件产品在生产环境安全上线的一种重要手段。本章指导您使用服务网格技术实现灰度发布的几种场景。

服务网格基于Istio提供的服务治理能力，对服务提供多版本支持和灵活的流量策略，从而支持多种灰度发布场景。

当前版本支持金丝雀发布和蓝绿发布，ABTest和自定义即将开放，敬请期待。

## 前提条件<a name="section77301553236"></a>

已创建应用，且服务中已有一个生产版本在线，例如版本号为v1。详细步骤请参见[创建应用](创建应用.md)。

## 蓝绿发布<a name="section82561111111"></a>

蓝绿发布提供了一种零宕机的部署方式。不停老版本，部署新版本进行测试，确认OK，将流量切到新版本，然后老版本同时也升级到新版本。始终有两个版本同时在线，有问题可以快速切换。

**蓝绿发布的特点是：**在部署应用的过程中，应用始终在线。并且新版本上线过程中，不会修改老版本的任何内容，在部署期间老版本状态不受影响。只要老版本的资源不被删除，可以在任何时间回滚到老版本。

## A/B Testing<a name="section972381761119"></a>

当产品已经相对稳定，已经上线并有一定数量的用户在使用时，企业会面临一个压力：任何的更新或者优化是否一定比原来更好？

**A/B Testing的特点是：**通过A/B Testing可以帮助企业对新版本进行测试验证。针对新上线的版本配置一定的引流规则，将少量用户的访问流量引入到新版本。通过访问样本的评估以及数据分析，评价该版本被接受的程度，确定是否需要将全部流量切到该版本上。

## 金丝雀发布<a name="section18766329162914"></a>

在生产环境上引一部分实际流量对一个新版本进行测试，测试新版本的性能和表现，在保证系统整体稳定运行的前提下，尽早发现新版本在实际环境上的问题。

**金丝雀发布的特点：**

通过在线上运行的服务中，新加入少量的新版本的服务，然后从这少量的新版本中快速获得反馈，根据反馈决定最后的交付形态。

**操作步骤：**

1.  参考[创建应用](创建应用.md)部署第一个版本，所有外部的流量都会进入该版本。

    在CCE左侧导航栏中选择“应用治理“，打开[应用服务网格控制台](https://console.huaweicloud.com/istio/)，单击左侧导航栏中的“灰度发布”。

2.  单击金丝雀发布下的“创建”。假设当前服务下已有一个版本在线，例如版本号为V1。
3.  参照[为组件添加灰度版本](为组件添加灰度版本.md)，为组件新上线一个灰度版本，例如版本号为V2。

    >![](public_sys-resources/icon-note.gif) **说明：**   
    >新上线的V2版本须在研发环境已充分测试，诉求是需要在生产环境进行深度验证。  

    在配置灰度策略时，请根据业务需求，将“部分流量“或“满足一定条件的请求“引入V2版本。

    配置完成后，满足灰度策略的流量或请求走V2版本，不满足灰度策略的流量走V1版本。

4.  根据业务具体情况，对接收到实际流量的V2版本进行评价。
    1.  当评价V2版本满足要求时，单击V2版本后的“接管所有流量”，则所有的流量都会切换到V2版本上。
    2.  在V2版本运行一段时间后，建议删除V1版本，并释放V1版本的资源。


